input {
    redis {
        key => "redis_logger"
        data_type => "list"
        host => "${REDIS_HOST}"
        port => 6379
        codec => "json"
    }
}

filter {
    if [type] == "tests-log" {
        mutate { add_field => { "[@metadata][index]" => "bgds_dc_tests" } }
    } else if [type] == "error-log" {
        mutate { add_field => { "[@metadata][index]" => "bgds_dc_error" } }
    } else {
        mutate { add_field => { "[@metadata][index]" => "bgds_dc_default" } }
    }
}

output {
    elasticsearch {
        hosts => ["https://${ELASTICSEARCH_HOST}:9200"]
        user => "${LOGSTASH_USER}"
        password => "${LOGSTASH_PASSWORD}"
        index => "%{[@metadata][index]}"
        retry_on_conflict => 3
        timeout => 60
        action => "index"
        manage_template => true
        template_name => "logstash_dynamic_template"
        template_overwrite => true
        template => "/usr/share/logstash/config/elasticsearch-template.json"
        ssl_verification_mode => "full"
        ssl_certificate_authorities => "${LOGSTASH_CACERT}"
        ssl_keystore_path => "${LOGSTASH_P12}"
        ssl_keystore_password => "${LOGSTASH_KEYSTORE_PASS}"
    }
}
